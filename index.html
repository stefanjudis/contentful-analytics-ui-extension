<!DOCTYPE html>
<html>
  <head>
    <title>Contentful Analytics UI-extension</title>
    <link
      rel="stylesheet"
      href="https://contentful.github.io/ui-extensions-sdk/cf-extension.css"
    />
    <script src="https://unpkg.com/contentful-ui-extensions-sdk@3"></script>
    <script>
      (function(w, d, s, g, js, fjs) {
        g = w.gapi || (w.gapi = {});
        g.analytics = {
          q: [],
          ready: function(cb) {
            this.q.push(cb);
          }
        };
        js = d.createElement(s);
        fjs = d.getElementsByTagName(s)[0];
        js.src = 'https://apis.google.com/js/platform.js';
        fjs.parentNode.insertBefore(js, fjs);
        js.onload = function() {
          g.load('analytics');
        };
      })(window, document, 'script');
    </script>
    <script src="https://ga-dev-tools.appspot.com/public/javascript/embed-api/components/date-range-selector.js"></script>
  </head>
  <body>
    <div id="date-range-selector"></div>
    <section id="timeline"></section>
    <section id="auth-button"></section>
    <button id="signOff">Log out</button>
    <script>
      window.contentfulExtension.init(({ entry, parameters, window }) => {
        window.startAutoResizer();
        const {
          clientId: clientid,
          viewId,
          prefix,
          slugId
        } = parameters.instance;

        gapi.analytics.ready(() => {
          if (gapi.analytics.auth.isAuthorized) {
            const startRange = {
              'start-date': '30daysAgo',
              'end-date': 'today'
            };

            const dateRangeSelector = new gapi.analytics.ext.DateRangeSelector({
              container: 'date-range-selector'
            })
              .set(startRange)
              .execute();

            const timeline = new gapi.analytics.googleCharts.DataChart({
              reportType: 'ga',
              query: {
                ...{
                  ids: viewId,
                  dimensions: 'ga:date',
                  metrics: 'ga:sessions',
                  filters: `ga:pagePath==/${
                    prefix ? `${prefix}/` : ''
                  }${entry.fields[slugId].getValue()}/`
                },
                ...startRange
              },
              chart: {
                type: 'LINE',
                container: 'timeline',
                options: {
                  width: '100%',
                  backgroundColor: '#f7f9fa'
                }
              }
            });

            timeline.execute();

            dateRangeSelector.on('change', function(data) {
              timeline.set({ query: data }).execute();
            });

            document.getElementById('signOff').addEventListener('click', () => {
              gapi.analytics.auth.signOut();
              window.location.reload();
            });
          } else {
            gapi.analytics.auth.authorize({
              container: 'auth-button',
              clientid
            });
          }
        });
      });
    </script>
  </body>
</html>
