<!DOCTYPE html>
<html>
  <head>
    <title>Contentful Analytics UI-extension</title>
    <script src="https://unpkg.com/contentful-ui-extensions-sdk@3"></script>
    <script>
      (function(w, d, s, g, js, fjs) {
        g = w.gapi || (w.gapi = {});
        g.analytics = {
          q: [],
          ready: function(cb) {
            this.q.push(cb);
          }
        };
        js = d.createElement(s);
        fjs = d.getElementsByTagName(s)[0];
        js.src = 'https://apis.google.com/js/platform.js';
        fjs.parentNode.insertBefore(js, fjs);
        js.onload = function() {
          g.load('analytics');
        };
      })(window, document, 'script');
    </script>
    <link
      rel="stylesheet"
      href="https://contentful.github.io/ui-extensions-sdk/cf-extension.css"
    />
    <style>
      body {
        margin: 0;
        padding: 1px;
      }

      .range {
        display: flex;
        padding: 0.5em 0;
        justify-content: space-between;
      }

      .range label {
        flex: 1;
        max-width: 47.5%;
      }

      .range input {
        width: 100%;
      }

      .dimensions {
        font-size: 0.875em;
        display: flex;
        border: 1px solid #ccc;
        border-radius: 0.25em;
        text-align: center;
        background: #fff;
      }

      .dimensions input {
        display: none;
      }

      .dimensions label {
        padding: 0.25em;
        flex: 1;
      }

      .dimensions label.is-active {
        background: #eee;
        text-decoration: underline;
      }

      .dimensions label + label {
        border-left: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <div id="date-range-selector"></div>
    <section id="auth-button"></section>
    <main>
      <header class="controls"></header>
      <section id="timeline"></section>
    </main>
    <script type="module">
      import {
        html,
        render,
        Component
      } from 'https://unpkg.com/htm/preact/standalone.mjs';

      const DAY_IN_MS = 1000 * 60 * 60 * 24;
      const TODAY = new Date();
      const TIMELINE_DIMENSIONS = [
        { label: 'Day', value: 'date' },
        { label: 'Week', value: 'week' },
        { label: 'Month', value: 'month' }
      ];

      const formatDate = date => date.toISOString().slice(0, 10);

      class Controls extends Component {
        constructor({ entry }) {
          super();

          this.state = {
            range: {
              start: new Date(TODAY - DAY_IN_MS * 14),
              end: TODAY
            },
            dimension: 'date',
            entry
          };
        }

        handleDateChange({ target }) {
          const { range } = this.state;
          range[target.name] = target.valueAsDate;

          this.setState({
            range
          });
        }

        handleDimensionChange({ target }) {
          this.setState({
            dimension: target.value
          });
        }

        render() {
          const { range } = this.state;
          const { entry, signout } = this.props;

          if (!entry.getSys().publishedAt) {
            return html`
              Nothing to analyze... entry is not published.
            `;
          }

          this.renderTimeline();

          return html`
            <section>
              <div class="range">
                <label>
                  From
                  <input
                    name="start"
                    type="date"
                    onchange=${this.handleDateChange.bind(this)}
                    value="${formatDate(range.start)}"
                  />
                </label>
                <label>
                  To
                  <input
                    name="end"
                    type="date"
                    onchange=${this.handleDateChange.bind(this)}
                    value="${formatDate(range.end)}"
                    max="${formatDate(TODAY)}"
                  />
                </label>
              </div>
              <div class="dimensions">
                ${TIMELINE_DIMENSIONS.map(dimension => {
                  const isActive = dimension.value === this.state.dimension;

                  return html`
                    <label class="${isActive ? 'is-active' : ''}">
                      ${dimension.label}
                      <input
                        type="radio"
                        name="dimension"
                        value="${dimension.value}"
                        onchange=${this.handleDimensionChange.bind(this)}
                        checked=${isActive}
                      />
                    </label>
                  `;
                })}
              </div>
              <button class="cf-btn-primary" onclick="${() =>
                console.log('jooo')}>Sign out</button>
            </section>
          `;
        }

        renderTimeline() {
          const { entry, prefix, slugId, viewId } = this.props;
          const { range, dimension } = this.state;

          this.props.timeline
            .set({
              query: {
                ...{
                  ids: this.props.viewId,
                  dimensions: `ga:${dimension}`,
                  metrics: 'ga:sessions',
                  filters: `ga:pagePath==/${
                    prefix ? `${prefix}/` : ''
                  }${entry.fields[slugId].getValue()}/`
                },
                'start-date': formatDate(range.start),
                'end-date': formatDate(range.end)
              }
            })
            .execute();
        }
      }

      window.contentfulExtension.init(({ entry, parameters, window }) => {
        gapi.analytics.ready(() => {
          window.startAutoResizer();

          gapi.analytics.auth.authorize({
            container: 'auth-button',
            clientid: parameters.instance.clientId
          });

          const timeline = new gapi.analytics.googleCharts.DataChart({
            reportType: 'ga',
            chart: {
              type: 'LINE',
              container: 'timeline',
              options: {
                width: '100%',
                backgroundColor: '#f7f9fa'
              }
            }
          });

          render(
            html`
              <${Controls}
                entry=${entry}
                timeline=${timeline}
                ...${parameters.instance}
              />
            `,
            document.querySelector('.controls')
          );
        });
      });
    </script>
  </body>
</html>
