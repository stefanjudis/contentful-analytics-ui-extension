<!DOCTYPE html>
<html>
  <head>
    <title>Contentful Analytics UI-extension</title>
    <script src="https://unpkg.com/contentful-ui-extensions-sdk@3"></script>
    <script>
      (function(w, d, s, g, js, fjs) {
        g = w.gapi || (w.gapi = {});
        g.analytics = {
          q: [],
          ready: function(cb) {
            this.q.push(cb);
          }
        };
        js = d.createElement(s);
        fjs = d.getElementsByTagName(s)[0];
        js.src = 'https://apis.google.com/js/platform.js';
        fjs.parentNode.insertBefore(js, fjs);
        js.onload = function() {
          g.load('analytics');
        };
      })(window, document, 'script');
    </script>
    <link
      rel="stylesheet"
      href="https://contentful.github.io/ui-extensions-sdk/cf-extension.css"
    />
    <style>
      body {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div id="date-range-selector"></div>
    <section id="auth-button"></section>
    <main>
      <header class="controls"></header>
      <section id="timeline"></section>
    </main>
    <button id="signOff" class="cf-btn-primary">Log out</button>
    <script type="module">
      import {
        html,
        render,
        Component
      } from 'https://unpkg.com/htm/preact/standalone.mjs';

      const DAY_IN_MS = 1000 * 60 * 60 * 24;
      const TODAY = new Date();

      const TIMELINE_DIMENSIONS = ['day', 'week', 'month'];

      const formatDate = date => date.toISOString().slice(0, 10);

      class Controls extends Component {
        constructor({ entry }) {
          super();

          this.state = {
            range: {
              start: new Date(TODAY - DAY_IN_MS * 14),
              end: TODAY
            },
            dimension: 'day',
            entry
          };

          console.log('*****************************');
          console.log(entry);
          console.log('sys', entry.getSys());
        }

        handleDateChange({ target }) {
          const { range } = this.state;
          range[target.name] = target.valueAsDate;

          this.setState({
            range
          });
        }

        handleDimensionChange({ target }) {
          this.setState({
            dimension: target.value
          });
        }

        render() {
          const { range } = this.state;
          const { entry } = this.props;

          if (!entry.getSys().publishedAt) {
            return html`
              nothing to analyze... entry is not published
            `;
          }

          this.renderTimeline();

          return html`
            <section>
              <div>
                <label>
                  Start date
                  <input
                    name="start"
                    type="date"
                    onchange=${this.handleDateChange.bind(this)}
                    value="${formatDate(range.start)}"
                  />
                </label>
                <label>
                  End date
                  <input
                    name="end"
                    type="date"
                    onchange=${this.handleDateChange.bind(this)}
                    value="${formatDate(range.end)}"
                    max="${formatDate(TODAY)}"
                  />
                </label>
              </div>
              <div>
                ${
                  TIMELINE_DIMENSIONS.map(
                    dimension => html`
                      <label>
                        ${dimension}
                        <input
                          type="radio"
                          name="dimension"
                          value="${dimension}"
                          onchange=${this.handleDimensionChange.bind(this)}
                          checked=${dimension === this.state.dimension}
                        />
                      </label>
                    `
                  )
                }
              </div>
            </section>
          `;
        }

        renderTimeline() {
          const { entry, prefix, slugId, viewId } = this.props;
          const { range, dimension } = this.state;

          this.props.timeline
            .set({
              query: {
                ...{
                  ids: this.props.viewId,
                  dimensions: `ga:${dimension}`,
                  metrics: 'ga:sessions',
                  filters: `ga:pagePath==/${
                    prefix ? `${prefix}/` : ''
                  }${entry.fields[slugId].getValue()}/`
                },
                'start-date': formatDate(range.start),
                'end-date': formatDate(range.end)
              }
            })
            .execute();
        }
      }

      window.contentfulExtension.init(({ entry, parameters, window }) => {
        gapi.analytics.ready(() => {
          window.startAutoResizer();

          gapi.analytics.auth.authorize({
            container: 'auth-button',
            clientid: parameters.instance.clientId
          });

          console.log(parameters.instance);
          const timeline = new gapi.analytics.googleCharts.DataChart({
            reportType: 'ga',
            chart: {
              type: 'LINE',
              container: 'timeline',
              options: {
                width: '100%',
                backgroundColor: '#f7f9fa'
              }
            }
          });

          render(
            html`
              <${Controls}
                entry=${entry}
                timeline=${timeline}
                ...${parameters.instance}
              />
            `,
            document.querySelector('.controls')
          );
        });

        // const {
        //   clientId: clientid,
        //   viewId,
        //   prefix,
        //   slugId
        // } = parameters.instance;

        // gapi.analytics.ready(() => {
        //   console.log(
        //     gapi.analytics.auth.isAuthorized,
        //     'isAuthorized',
        //     '+***********************'
        //   );
        //   gapi.analytics.auth.authorize({
        //     container: 'auth-button',
        //     clientid
        //   });
        //   const startRange = {
        //     'start-date': '30daysAgo',
        //     'end-date': 'today'
        //   };

        //   const dateRangeSelector = new gapi.analytics.ext.DateRangeSelector({
        //     container: 'date-range-selector'
        //   })
        //     .set(startRange)
        //     .execute();

        //   timeline.execute();

        //   dateRangeSelector.on('change', function(data) {
        //     timeline.set({ query: data }).execute();
        //   });

        //   document.getElementById('signOff').addEventListener('click', () => {
        //     gapi.analytics.auth.signOut();
        //     window.location.reload();
        //   });
        // });
      });
    </script>
  </body>
</html>
