<!DOCTYPE html>
<html>
  <head>
    <title>Contentful Analytics UI-extension</title>
    <script src="https://unpkg.com/contentful-ui-extensions-sdk@3"></script>
    <script>
      (function(w, d, s, g, js, fjs) {
        g = w.gapi || (w.gapi = {});
        g.analytics = {
          q: [],
          ready: function(cb) {
            this.q.push(cb);
          }
        };
        js = d.createElement(s);
        fjs = d.getElementsByTagName(s)[0];
        js.src = 'https://apis.google.com/js/platform.js';
        fjs.parentNode.insertBefore(js, fjs);
        js.onload = function() {
          g.load('analytics');
        };
      })(window, document, 'script');
    </script>
    <link
      rel="stylesheet"
      href="https://contentful.github.io/ui-extensions-sdk/cf-extension.css"
    />
  </head>
  <body>
    <div id="date-range-selector"></div>
    <section id="timeline"></section>
    <section id="auth-button"></section>
    <main></main>
    <button id="signOff" class="cf-btn-primary">Log out</button>
    <script type="module">
      import {
        html,
        render,
        Component
      } from 'https://unpkg.com/htm/preact/standalone.mjs';

      class App extends Component {
        constructor({ entry }) {
          super();

          this.state = {
            entry
          };

          console.log('*****************************');
          console.log(entry);
          console.log('sys', entry.getSys());
        }

        handleDateChange(event) {
          console.log(event);
        }

        render() {
          const { entry } = this.state;

          if (!entry.getSys().publishedAt) {
            return html`
              nothing to analyze... entry is not published
            `;
          }

          return html`
            <div>
              <label>
                Start date
                <input
                  type="date"
                  onchange=${this.handleDateChange.bind(this)}
                />
              </label>
              <label>
                End date
                <input
                  type="date"
                  onchange=${this.handleDateChange.bind(this)}
                />
              </label>
            </div>
          `;
        }
      }

      window.contentfulExtension.init(({ entry, parameters, window }) => {
        gapi.analytics.ready(() => {
          window.startAutoResizer();

          render(
            html`
              <${App} entry=${entry} />
            `,
            document.querySelector('main')
          );
        });

        // const {
        //   clientId: clientid,
        //   viewId,
        //   prefix,
        //   slugId
        // } = parameters.instance;

        // gapi.analytics.ready(() => {
        //   console.log(
        //     gapi.analytics.auth.isAuthorized,
        //     'isAuthorized',
        //     '+***********************'
        //   );
        //   gapi.analytics.auth.authorize({
        //     container: 'auth-button',
        //     clientid
        //   });
        //   const startRange = {
        //     'start-date': '30daysAgo',
        //     'end-date': 'today'
        //   };

        //   const dateRangeSelector = new gapi.analytics.ext.DateRangeSelector({
        //     container: 'date-range-selector'
        //   })
        //     .set(startRange)
        //     .execute();

        //   const timeline = new gapi.analytics.googleCharts.DataChart({
        //     reportType: 'ga',
        //     query: {
        //       ...{
        //         ids: viewId,
        //         dimensions: 'ga:date',
        //         metrics: 'ga:sessions',
        //         filters: `ga:pagePath==/${
        //           prefix ? `${prefix}/` : ''
        //         }${entry.fields[slugId].getValue()}/`
        //       },
        //       ...startRange
        //     },
        //     chart: {
        //       type: 'LINE',
        //       container: 'timeline',
        //       options: {
        //         width: '100%',
        //         backgroundColor: '#f7f9fa'
        //       }
        //     }
        //   });

        //   timeline.execute();

        //   dateRangeSelector.on('change', function(data) {
        //     timeline.set({ query: data }).execute();
        //   });

        //   document.getElementById('signOff').addEventListener('click', () => {
        //     gapi.analytics.auth.signOut();
        //     window.location.reload();
        //   });
        // });
      });
    </script>
  </body>
</html>
